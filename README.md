
# Справочник сотрудников

Приложение командной стороки для работы с базой данных. Выполнено в качестве решения тестового задания, требования:
 + Написать приложения, которое будет запускаться из консоли с параметрами
 + Первый параметр - цифра, определяющая режим работы приложения
 + Приложение должно подключаться к базе данных, в качестве СУБД можно использовать любую SQL СУБД
 + Режимы работы: 
    - 1 создание таблицы с полями справочника сотрудников
    - 2 создание записи справочника
    - 3 вывод всех строк спавочника с уникальным занчением ФИО, вывести также количество полных лет сотрудника
    - 4 заполнение автоматически 1000000 строк спавочника, добавить заполнение 100 строк в которых пол мужской и фамилия начинается с "F"
    - 5 результат выборки из таблицы по критерию: пол мужской, фамилия начинается с "F", вывод должен содержать время выполенения
  + Проивести оптимизацю базы данных для ускорения выполнения режима 5


## Основные инструменты

- Python
- Click - библиотека для создания интерфейсов командной строки -> [документация](https://click.palletsprojects.com/en/8.1.x/)
- SQLAlchemy - библиотека Python для работы с СУБД -> [документация](https://www.sqlalchemy.org/)
- SQLite3 - легкая однофайловая база данных -> [документация](https://www.sqlite.org/)



## Установка

- Скопировать директорию с проектом на жесткий диск

- Создать вирутальное окружение (version: Python 3.10.12)
```bash
python3 -m venv env
```
- Выполнить скрипт активации вирутального окружения
```bash
source env/bin/activate
```
- Установить необходимые зависимости
```bash
pip install -r requirements.txt
```

    
## Доступный функционал и примеры использования

Точка входа - модуль main.py

Для просмотра доступных режимов работы

```bash
  python main.py --help
```

### Команды
Создание файла базы данных database.db и таблицы employee_account

```bash
  python main.py 1
```

Создание записи сотрудника с параметрами: полное имя, дата рождения, пол

```bash
  python main.py 2 "Ivanov Ivan Ivanovich" 2000-01-01 Male
```

Вывод всех строк справочника с дополнительным полем "количество полных лет"

```bash
  python main.py 3
```

Заполнение автоматически 1000000 строк справочника со  случайными данными 
и дополнительно 100 строк с фамилиями начинающимися с 'F'

```bash
  python main.py 4
```

Вывод выборки из справочника по критериям: пол мужской, фамилия начинается с 'F'
Также выводит на экран время исполнения команды

```bash
  python main.py 5
```
## Отчет

Для создания интерфейса командной строки использована библиотека Click, которая позволяет быстро реализовать CLI с помощью встроенных инструментов

В качестве базы данных выбрана SQLite, которая является легким и быстрым инструменом. База данных представляет собой файл с расширение .db, который хранится в директории проекта.

Для работы с базой данных выбрана библиотека SQLAlchemy, которая позволяет управлять базами данных без использования чистого SQL, только с применением структур языка Python. Этот инструмент является достаточно гибким, кроме того библиотека имеет множество встроенных оптимизаций для рабогты с БД. Также в целях оптимизации запросов к базе данных по полю fullname создается индекс по данному полю при создании таблицы.

При создании приложения использоват объектно-ориентированный подход. Так, таблицу БД в приложении представляет связанный класс Employee, который унаследован от класса Base библиотеки SQLAlchemy. Атрибуты класса представляют поля таблицы, в которых также можно указывать параметры первичного ключа, типа данных, индексирования, ограничений и др.

```Python
class Employee(Base):
    __tablename__ = "employee_account"

    id: Mapped[int] = mapped_column(primary_key=True)
    fullname: Mapped[str] = mapped_column(
        String(80), index=True
    )  # Создание индекса в БД для оптимизации запросов по полю fullname
    birth_date: Mapped[str] = mapped_column(Date)
    gender: Mapped[str] = mapped_column(String(6))
```
Модуль app.py содержит класс MyApp, который предоставляет методы для работы с базой данных, а также ряд статических методов для различных вспомогательных функций. Например метод MyApp.select_from_db() реализует запрос к базе данных и вывод результата в консоль.
```Python
def select_from_db(self) -> None:
    """
    Make select query to database
    and print all employees with
    fullname starts with 'F' and Male gender
    """
    with Session(engine) as session:
        stmt = select(
            Employee.fullname, Employee.birth_date, Employee.gender
        ).where(Employee.fullname.istartswith("F"), Employee.gender == "Male")
        for row in session.execute(stmt):
            print(row.fullname, row.birth_date, row.gender)
``` 
Здесь создается сессия подключения к базе данных с использованием менеджера контекста. ORM SQLAlchemy позволяет создавать гибкие запросы к БД без использования чистого SQL. Резльтат представляет собой итерируемый объект, каждое строка в котором выводится в консоль.

В модуле main.py создан экземпляр класса MyApp, а также функции, декорированные как команды CLI в соответствии с документацией библиотеки [Click](https://click.palletsprojects.com/en/8.1.x/). Функции вызываеют соответстующие методы экземпляра класса MyApp, также реализован перехват возможных исключений. Например функция create_person должна получить в качестве параметра кортеж данных.
```Python
@cli.command(
    "2",
    short_help="create an employee's account ARGS: 'fullname' 'birth_date' 'gender'",
)
@click.argument("data", nargs=-1)
def create_person(data: tuple):
    """
    Call app method to insert employee's data into the database
    """
    try:
        app.create_employee(data)
        print(f"Employee's account is created: {data}")
    except IndexError:
        print(
            'Must be 3 args! Example: main.py 2 "Ivanov Ivan Ivanovich" "2000-01-01" Male'
        )
    except ValueError:
        print(
            'Wrong data format! Example: main.py 2 "Ivanov Ivan Ivanovich" "2000-01-01" Male'
        )
```
С помощью конструкции try/except реализован перехват исключений связанных с неверным количеством или форматом переданных пользователем параметров.

Для автоматического форматирования кода использованы библиотеки [Black](https://github.com/psf/black) и [isort](https://pycqa.github.io/isort/).

